<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stock Viewer</title>

<!-- ================= UI STYLE ================= -->
<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f2f2f7;
  }

  header {
    padding: 16px;
    font-size: 22px;
    font-weight: 600;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 10;
    display: flex;
    justify-content: space-between;
  }

  .badge {
    background: #ff3b30;
    color: #fff;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 12px;
  }

  .container { padding:16px; display:grid; gap:16px; }

  .card {
    background:#fff;
    border-radius:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    overflow:hidden;
    cursor:pointer;
  }

  .card-body { padding:14px; }
  .name { font-weight:600; }
  .price { color:#007aff; margin-top:4px; }
  .stock { font-size:14px; color:#666; }

  .sheet-backdrop {
    position:fixed; inset:0;
    background:rgba(0,0,0,.25);
    display:none; z-index:100;
  }

  .sheet {
    position:fixed;
    left:0; right:0; bottom:-100%;
    background:#fff;
    border-radius:22px 22px 0 0;
    padding:20px;
    transition:.3s;
    z-index:101;
  }

  .sheet.show { bottom:0; }

  input[type=number] {
    width:100%;
    padding:12px;
    font-size:18px;
    border-radius:12px;
    border:1px solid #ddd;
    margin:12px 0;
  }

  .add-btn {
    width:100%;
    padding:14px;
    background:#007aff;
    color:#fff;
    border:none;
    border-radius:14px;
    font-size:16px;
    font-weight:600;
  }
</style>
</head>
<body>

<header>
  <div>Products</div>
  <div>ðŸ›’ <span id="cartBadge" class="badge" style="display:none">0</span></div>
</header>

<div id="app" class="container"></div>

<div id="backdrop" class="sheet-backdrop"></div>
<div id="sheet" class="sheet"></div>

<script>
/* ================= GLOBAL STATE ================= */
const state = {
  products: [],
  selectedProduct: null,
  qty: 1,
  cart: []
};

/* ================= API LAYER ================= */
const API_URL = "https://script.google.com/macros/s/AKfycby5H_jyKgM0l0XWzpzO4pBRvdfjQuXJppaNJuXrmAXN6RuDGpg0W42TmDtactLJrqMz/exec";

const fetchProducts = async () =>
  fetch(`${API_URL}?action=products`).then(r=>r.json());

/* ================= RENDER ================= */
function renderProducts(){
  app.innerHTML = "";
  state.products.forEach(p=>{
    if(!p.active) return;
    const c=document.createElement("div");
    c.className="card";
    c.onclick=()=>openSheet(p);
    c.innerHTML=`
      <div class="card-body">
        <div class="name">${p.name}</div>
        <div class="price">à¸¿${p.price}</div>
        <div class="stock">Stock: ${p.stock}</div>
      </div>`;
    app.appendChild(c);
  });
}

function renderSheet(){
  const p=state.selectedProduct;
  sheet.innerHTML=`
    <div class="name">${p.name}</div>
    <div class="price">à¸¿${p.price}</div>
    <div class="stock">Available: ${p.stock}</div>

    <input type="number"
      min="0"
      max="${p.stock}"
      value="${state.qty}"
      oninput="updateQty(this.value)" />

    <button class="add-btn" onclick="addToCart()">Add to Cart</button>
  `;
}

function renderBadge(){
  const b=document.getElementById("cartBadge");
  const count=state.cart.length;
  b.style.display=count?"inline-block":"none";
  b.textContent=count;
}

/* ================= VIEWER FLOW ================= */
function openSheet(p){
  state.selectedProduct=p;
  state.qty=1;
  renderSheet();
  backdrop.style.display="block";
  sheet.classList.add("show");
}

function closeSheet(){
  backdrop.style.display="none";
  sheet.classList.remove("show");
}

function updateQty(v){
  const max=state.selectedProduct.stock;
  state.qty=Math.max(0,Math.min(max,Number(v)||0));
}

function addToCart(){
  const p=state.selectedProduct;
  const found=state.cart.find(i=>i.productId===p.productId);

  if(found) found.qty=state.qty;
  else state.cart.push({
    productId:p.productId,
    name:p.name,
    price:p.price,
    qty:state.qty
  });

  renderBadge();
  closeSheet();
}

backdrop.onclick=closeSheet;

/* ================= INIT ================= */
(async()=>{
  state.products=await fetchProducts();
  renderProducts();
})();
</script>
</body>
</html>
